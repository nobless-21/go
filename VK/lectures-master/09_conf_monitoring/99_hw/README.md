# Домашнее задание №9

## Красивая предыстория

Теперь вы ответственны за сервис, который находится в глубочайшем
упадке. Пользователи постоянно недовольны и уходят в другие сервисы.
Причиной этому могут быть постоянные ошибки в теперь вашем сервисе и
его долгая работа. Ваш сервис представляет собой апишку, которая
ходит во внешние сервисы. Таким образом, логики внутри данного сервиса
очень мало, нет никаких сложных операций: только http походы. Необходимо
понять что за сервисы влекут за собой ошибки и сообщить ответственным за
те сервисы.

## Точка отправления

У нас есть сервис, который написан на фреймворке echo. В нём можно

- Создать тред (POST /thread + тело json)
- Получить тред (GET /thread/:id)
- Создать коммент (POST /thread/:id/comment + тело json)
- Лайкнуть коммент (POST /thread/:id/comment/:id)

Для авторизации используется кука user, например `user=user_1`

Создание и получение треда ходит во внешний сервис `vk-golang.ru:15000`
SLA данного сервиса: ~10ms на ответ и 100% статусов 200

Создание и лайк коммента ходит во внешний сервис `vk-golang.ru:16000`
SLA данного сервиса: ~20ms на ответ и 100% статусов 200

Сервисом авторизации в данном случае выступает `vk-golang.ru:17000`
SLA данного сервиса: ~5ms на ответ и 0% статусов 500

Всё, что выходит за рамки SLA в более чем два раза, необходимо репортить
ответственному за сервисы, то есть преподавателю.

## Требования

0. Необходимо добавить разноуровневое логирование всего, что происходит
для того, чтобы понимать, какие ошибки появляются и откуда.
   1. Для начала нужно логировать всё в рамках одного запроса, чтобы понимать,
   какая произошла ошибка и на каком этапе. Для связи всех логов используется
   request-id, который должен генерироваться в middleware и пробрасываться через контекст.
   2. Нужно логировать все результаты запроса, так называемые access log. Они содержат в
   себе информацию о том кто пришёл, когда пришёл, какой request-id, какой статус ответа
   3. Нужно логировать все внешние походы: куда и какой статус ответа
   4. Нужно логировать ошибки, которые произошли во время запроса
1. Необходимо поднять prometheus и grafana
2. Необходимо замониторить ключевые метрики:
   1. Количество хитов на каждый конец с распределением по статусу ответа
   2. Тайминги хитов на каждый конец
   3. Статусы ответов внешних сервисов
   4. Тайминги ответов внешних сервисов
3. Построить дашборд с графиками по этим метрикам в графане
4. На основе этих метрик нужно выявить проблемные точки(долгие тайминги, невалидные ответы) и сообщить о них ответственному(в данном случае преподавателю) - демонстрация графика (ссылка на графану с указанием периода на который смотреть)
5. Получить рекомендации преподавателя по устранению проблем и устранить их
6. Проверить дашборд и соблюдение SLA после добавления изменений - демонстрация графика (ссылка на графану с указанием периода на который смотреть)
7. (Опционально за 3 доп. балла) Настроить алерты в чатик
телеграма о том, что появились невалидные ответы или таймауты. То
есть нарушен SLA. При этом их нужно будет проверить. В любой
момент какой-либо внешний сервис может упасть на 5 минут. Для
засчитывания баллов по этому пункту необходимо среагировать и
написать преподавателю о том, что сервис лежит с пересылкой
алерта из чата. Договоримся, что падать сервис будет строго вечером
с 19 до 21. В любое время.

### Требования к оформлению дашборда
0. Указание единиц измерения чтобы было удобно проверять соблюдение SLA (+ опционально добавить черточки на уровне SLA и SLAx2)

## Среда выполнения

Графики о сервисе должны быть доступны для захода извне. Для
этого мы вам можем выдать сервер, если вы не получили его
по восьмому дз. Для получения можно всё так же обратиться к
Антону Сулаеву.

## Нагрузка пользователей

Для имитации нагрузки пользователей вы можете поднять свой сервис
на своём сервере и уведомить об этом преподавателя. Преподаватель в свою
очередь поднимет docker образ на сервере с сервисами, который начнёт ходить
в ваш сервис в 10 потоков. Этот образ вы можете поднять точно так же у себя
локально:

- Для linux: `docker run --rm --network=host -e "SERVER_ADDR=localhost:8000" skinass/edu-vk-client /usr/local/bin/client`.
- Для mac/windows: `docker run --rm -e "SERVER_ADDR=host.docker.internal:8000" skinass/edu-vk-client /usr/local/bin/client`
